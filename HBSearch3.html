<!DOCTYPE html>
<html lang="zh-Hant">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Hyread é›»å­æ›¸å¤šé¤¨æŸ¥è©¢ Pro (Debug Lib Load)</title>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <style>
    :root {
      --primary-color: #007bff;
      --secondary-color: #6c757d;
      --success-color: #28a745;
      --warning-color: #ffc107;
      --danger-color: #dc3545;
      --light-color: #f8f9fa;
      --dark-color: #343a40;
      --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      --border-radius: 0.3rem;
      --box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    }

    body {
      font-family: var(--font-family);
      line-height: 1.6;
      margin: 0;
      padding: 0;
      background-color: #eef2f7;
      color: var(--dark-color);
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    
    .main-container {
        max-width: 1200px;
        margin: 20px auto;
        padding: 20px;
        background-color: #fff;
        border-radius: var(--border-radius);
        box-shadow: var(--box-shadow);
    }

    header {
      background: linear-gradient(135deg, var(--primary-color), #0056b3);
      color: white;
      padding: 20px;
      text-align: center;
      border-bottom: 5px solid #0056b3;
    }
    header h1 { margin: 0; font-size: 2rem; }

    .search-area, .settings-area, .library-selection-area, .results-area, .findbook-area {
      margin-bottom: 25px;
      padding: 20px;
      background-color: var(--light-color);
      border-radius: var(--border-radius);
      border: 1px solid #dee2e6;
    }
    
    .search-area h2, .settings-area h2, .library-selection-area h2, .results-area h2, .findbook-area h2 {
        margin-top: 0;
        color: var(--primary-color);
        border-bottom: 2px solid var(--primary-color);
        padding-bottom: 10px;
        font-size: 1.5rem;
    }

    input[type="text"], select {
      width: 100%;
      padding: 10px;
      margin-bottom: 10px;
      border: 1px solid #ced4da;
      border-radius: var(--border-radius);
      box-sizing: border-box;
      font-size: 1rem;
    }
    
    button, .button {
      background-color: var(--primary-color);
      color: white;
      padding: 10px 18px;
      border: none;
      border-radius: var(--border-radius);
      cursor: pointer;
      font-size: 1rem;
      transition: background-color 0.2s ease-in-out;
      text-decoration: none;
      display: inline-block;
      text-align: center;
    }
    button:hover, .button:hover { background-color: #0056b3; }
    button:disabled { background-color: var(--secondary-color); cursor: not-allowed; }

    .search-init-button { width: auto; min-width: 120px; }
    .action-button { padding: 8px 12px; font-size: 0.9rem; margin-left: 5px; }
    .pause-button { background-color: var(--warning-color); color: black; }
    .pause-button:hover { background-color: #e0a800; }
    .cancel-button { background-color: var(--danger-color); }
    .cancel-button:hover { background-color: #c82333; }

    #library-checkboxes-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 10px;
      max-height: 400px;
      overflow-y: auto;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: var(--border-radius);
      background-color: white;
      min-height: 50px; /* Added min-height for visibility during debugging */
    }
    #library-checkboxes-container label {
      display: flex;
      align-items: center;
      padding: 8px;
      background-color: #f8f9fa;
      border-radius: var(--border-radius);
      transition: background-color 0.2s;
      cursor: pointer;
    }
    #library-checkboxes-container label:hover { background-color: #e9ecef; }
    #library-checkboxes-container input[type="checkbox"] {
      margin-right: 10px;
      width: auto; 
      margin-bottom: 0; 
    }
    .library-group { margin-bottom: 15px; }
    .library-group h4 { margin-bottom: 8px; font-size: 1.1rem; color: var(--secondary-color); }

    .progress-container {
      margin: 15px 0;
      background-color: #e9ecef;
      border-radius: var(--border-radius);
      overflow: hidden;
    }
    .progress-bar {
      height: 25px;
      background: linear-gradient(45deg, var(--success-color), #218838);
      width: 0%;
      transition: width 0.3s ease;
      text-align: center;
      line-height: 25px;
      color: white;
      font-size: 0.9rem;
    }

    .status-info {
      margin: 15px 0;
      padding: 12px;
      background-color: #e6f7ff;
      border: 1px solid #b3e0ff;
      border-radius: var(--border-radius);
      font-size: 0.95rem;
    }
    .status-info div { margin-bottom: 5px; }
    .status-info span { font-weight: bold; }

    .settings-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 20px;
    }
    .setting-item label { display: block; margin-bottom: 8px; font-weight: 500; }
    .setting-item input[type="range"] { width: 100%; }
    .setting-item span { font-weight: normal; color: var(--primary-color); }

    #initial-results .result-item {
        padding: 10px;
        border-bottom: 1px solid #eee;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    #initial-results .result-item:last-child { border-bottom: none; }
    #initial-results .result-item span { flex-grow: 1; margin-right: 10px; }

    #detailed-findbook-results .book-entry {
      padding: 15px;
      margin-bottom: 15px;
      background-color: white;
      border: 1px solid #ddd;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
    }
    #detailed-findbook-results .book-entry a { color: var(--primary-color); text-decoration: none; font-weight: bold; }
    #detailed-findbook-results .book-entry a:hover { text-decoration: underline; }
    #detailed-findbook-results .book-entry hr { border: 0; border-top: 1px solid #eee; margin: 10px 0; }
    
    .safari-warning {
        background-color: #fff3cd;
        border-color: #ffeeba;
        color: #856404;
        padding: 15px;
        margin-bottom: 20px;
        border: 1px solid transparent;
        border-radius: var(--border-radius);
    }

    footer {
      text-align: center;
      padding: 15px;
      background-color: var(--dark-color);
      color: var(--light-color);
      margin-top: auto;
      font-size: 0.9em;
    }

    @media (max-width: 768px) {
      header h1 { font-size: 1.5rem; }
      .search-area h2, .settings-area h2, .library-selection-area h2, .results-area h2, .findbook-area h2 { font-size: 1.25rem; }
      #library-checkboxes-container { grid-template-columns: 1fr; }
      .settings-grid { grid-template-columns: 1fr; }
      button, .button { width: 100%; margin-bottom: 10px; }
      .action-button { width: auto; }
      .search-init-button { width: 100%; }
      #initial-results .result-item { flex-direction: column; align-items: flex-start; }
      #initial-results .result-item button { margin-top: 10px; }
    }
  </style>
</head>

<body>
  <header>
    <h1>Hyread é›»å­æ›¸å¤šé¤¨æŸ¥è©¢ Pro (Debug Lib Load)</h1>
  </header>

  <div class="main-container">
    <div id="safari-warning-placeholder" class="safari-warning" style="display:none;">
      âš ï¸ <strong>Safari ä½¿ç”¨è€…è«‹æ³¨æ„ï¼š</strong>ç”±æ–¼ç€è¦½å™¨å®‰å…¨é™åˆ¶ (CORS)ï¼Œéƒ¨åˆ†æˆ–å…¨éƒ¨åœ–æ›¸é¤¨çš„æŸ¥è©¢åŠŸèƒ½å¯èƒ½ç„¡æ³•æ­£å¸¸é‹ä½œã€‚å»ºè­°ä½¿ç”¨ Chrome æˆ– Firefox ç€è¦½å™¨ä»¥ç²å¾—æœ€ä½³é«”é©—ã€‚å¦‚æœå•é¡ŒæŒçºŒï¼Œé€™å¯èƒ½æ˜¯ Hyread ä¼ºæœå™¨ç«¯å°è«‹æ±‚ä¾†æºçš„é™åˆ¶ã€‚
    </div>

    <section class="search-area">
      <h2>1. è¼¸å…¥æ›¸åé—œéµå­—</h2>
      <input type="text" id="book-name-input" placeholder="ä¾‹å¦‚ï¼šåŸå­ç¿’æ…£">
      <button id="initial-search-button" class="search-init-button">æœå°‹æ›¸å</button>
    </section>

    <section class="results-area" id="initial-results-section" style="display:none;">
      <h2>2. é¸æ“‡è¦æŸ¥è©¢çš„æ›¸ç±ç‰ˆæœ¬</h2>
      <div id="initial-results"></div>
    </section>
    
    <section class="library-selection-area">
        <h2>3. é¸æ“‡åœ–æ›¸é¤¨ (<span id="selected-lib-count">0</span> å€‹å·²é¸)</h2>
        <div>
            <input type="checkbox" id="select-all-libraries" style="width:auto; margin-bottom: 0;">
            <label for="select-all-libraries" style="cursor:pointer; font-weight:bold;">å…¨é¸/å…¨ä¸é¸ (ç›®å‰ç¯©é¸çµæœ)</label>
            <input type="text" id="library-filter-input" placeholder="ç¯©é¸åœ–æ›¸é¤¨åç¨±..." style="margin-top:10px; margin-bottom:5px;">
        </div>
        <div id="library-checkboxes-container">
            <!-- Checkboxes will be populated by JavaScript -->
             <p style="color: grey; padding:10px;">æ­£åœ¨è¼‰å…¥åœ–æ›¸é¤¨åˆ—è¡¨...</p> <!-- Placeholder -->
        </div>
    </section>

    <section class="settings-area">
      <h2>4. é€²éšè¨­å®š (å¯é¸)</h2>
      <div class="settings-grid">
        <div class="setting-item">
          <label for="delay-slider">è«‹æ±‚é–“éš”åŸºç¤å€¼: <span id="current-delay-display">1.0ç§’</span></label>
          <input type="range" id="delay-slider" min="500" max="5000" value="1000">
          <span>(0.5ç§’ - 5ç§’)</span>
        </div>
        <div class="setting-item">
          <label for="batch-delay-slider">æ‰¹æ¬¡é–“å»¶é²: <span id="batch-delay-display">5.0ç§’</span></label>
          <input type="range" id="batch-delay-slider" min="3000" max="15000" value="5000">
          <span>(3ç§’ - 15ç§’)</span>
        </div>
        <div class="setting-item">
          <label for="batch-size-select">æ¯æ‰¹æ¬¡è™•ç†æ•¸é‡:</label>
          <select id="batch-size-select">
            <option value="3">3å€‹é¤¨ (è¼ƒå®‰å…¨)</option>
            <option value="5" selected>5å€‹é¤¨ (æ¨è–¦)</option>
            <option value="8">8å€‹é¤¨ (ç¨å¿«)</option>
            <option value="10">10å€‹é¤¨ (å¿«é€Ÿä½†é¢¨éšªå¢åŠ )</option>
          </select>
        </div>
      </div>
    </section>

    <section class="findbook-area" id="detailed-search-section" style="display:none;">
        <h2>5. åœ–æ›¸é¤¨è—æŸ¥è©¢é€²åº¦èˆ‡çµæœ</h2>
        <div class="findbook-controls" style="margin-bottom:15px;">
            <button id="pause-resume-button" class="action-button pause-button">æš«åœæœå°‹</button>
            <button id="cancel-search-button" class="action-button cancel-button">å–æ¶ˆæœå°‹</button>
        </div>
        <div class="progress-container">
            <div class="progress-bar">0/0</div>
        </div>
        <div class="status-info">
            <div>ğŸ“Š ç‹€æ…‹: <span id="status-message">å¾…æ©Ÿä¸­</span></div>
            <div>â³ ç›®å‰æ‰¹æ¬¡: <span id="current-batch-info">-</span> / <span id="total-batch-info">-</span></div>
            <div>âœ… æˆåŠŸ: <span id="success-count">0</span> | âŒ å¤±æ•—: <span id="failed-count">0</span> | ğŸ”„ å·²è™•ç†: <span id="processed-count">0</span>/<span id="total-count">0</span></div>
        </div>
        <div id="detailed-findbook-results">æŸ¥è©¢çµæœå°‡é¡¯ç¤ºæ–¼æ­¤</div>
    </section>
  </div>

  <footer>
    <p>Â© 2024 Hyread å¤šé¤¨æŸ¥è©¢ Pro. æ”¹è‰¯ç‰ˆã€‚</p>
  </footer>

  <script>
    // Global variables
    let selectedHyreadUrls = [];
    let isDetailedSearching = false;
    let isPaused = false;
    let currentSearchAbortController = null; 
    
    let successfulRequests = 0;
    let failedRequests = 0;
    let processedLibsCount = 0;
    let totalLibsToQuery = 0;
    let currentBatchNum = 0;
    let totalBatchesNum = 0;

    const delayConfig = {
      base: 1000,
      random: 500,
      batchDelay: 5000,
      errorMultiplier: 1.5 
    };

    // =======================================================================
    // == è«‹å°‡æ‚¨æ•´ç†å¥½çš„ libraryDataFull ç‰©ä»¶è²¼åœ¨æ­¤è™•æ›¿æ›ä¸‹é¢çš„ç¤ºä¾‹æ•¸æ“š ==
    // =======================================================================
    const libraryDataFull = {
        "åŒ—éƒ¨åœ°å€": [
            ["https://tpml.ebook.hyread.com.tw", "å°åŒ—å¸‚ç«‹åœ–æ›¸é¤¨"],
            ["https://tphcc.ebook.hyread.com.tw", "æ–°åŒ—å¸‚ç«‹åœ–æ›¸é¤¨"],
            ["https://klccab.ebook.hyread.com.tw", "åŸºéš†å¸‚æ–‡åŒ–å±€"],
            ["https://tycccgov.ebook.hyread.com.tw", "æ¡ƒåœ’å¸‚ç«‹åœ–æ›¸é¤¨"],
            ["https://hcmlgov.ebook.hyread.com.tw", "æ–°ç«¹å¸‚åœ–æ›¸é¤¨"],
            ["https://hchcc.ebook.hyread.com.tw", "æ–°ç«¹ç¸£å…¬å…±åœ–æ›¸é¤¨"],
            ["https://ilccb.ebook.hyread.com.tw", "å®œè˜­ç¸£æ”¿åºœæ–‡åŒ–å±€"],
        ],
        "ä¸­éƒ¨åœ°å€": [
            ["https://taichunggov.ebook.hyread.com.tw", "è‡ºä¸­å¸‚ç«‹åœ–æ›¸é¤¨"],
            ["https://bocach.ebook.hyread.com.tw", "å½°åŒ–ç¸£å…¬å…±åœ–æ›¸é¤¨"],
            ["https://chcedu.ebook.hyread.com.tw", "å½°åŒ–é›²ç«¯é›»å­æ›¸åº«"],
            ["https://nthccgov.ebook.hyread.com.tw", "å—æŠ•ç¸£å…¬å…±åœ–æ›¸é¤¨"], 
            ["https://ylccb.ebook.hyread.com.tw", "é›²æ—ç¸£å…¬å…±åœ–æ›¸é¤¨"],
        ],
        "å—éƒ¨åœ°å€": [
            ["https://cabcygov.ebook.hyread.com.tw", "å˜‰ç¾©å¸‚æ”¿åºœæ–‡åŒ–å±€"],
            ["https://cycabgov.ebook.hyread.com.tw", "å˜‰ç¾©ç¸£å…¬å…±åœ–æ›¸é¤¨"],
            ["https://tnml.ebook.hyread.com.tw", "è‡ºå—å¸‚ç«‹åœ–æ›¸é¤¨"],
            ["https://ksml.ebook.hyread.com.tw", "é«˜é›„å¸‚ç«‹åœ–æ›¸é¤¨"],
            ["https://pthggov.ebook.hyread.com.tw", "å±æ±ç¸£å…¬å…±åœ–æ›¸é¤¨"],
        ],
        "æ±éƒ¨åœ°å€": [
            ["https://hccc.ebook.hyread.com.tw", "èŠ±è“®ç¸£æ–‡åŒ–å±€"],
            ["https://jianlib.ebook.hyread.com.tw", "èŠ±è“®ç¸£å‰å®‰é„‰ç«‹åœ–æ›¸é¤¨"],
            ["https://hualienlib.ebook.hyread.com.tw", "èŠ±è“®ç¸£èŠ±è“®å¸‚ç«‹åœ–æ›¸é¤¨"],
            ["https://shlinlib.ebook.hyread.com.tw", "ç§€æ—é„‰ç«‹åœ–æ›¸é¤¨"],
            ["https://sinchenlib.ebook.hyread.com.tw", "æ–°åŸé„‰ç«‹åœ–æ›¸é¤¨"],
            ["https://cclttct.ebook.hyread.com.tw", "è‡ºæ±ç¸£æ”¿åºœæ–‡åŒ–è™•"],
        ],
        "é›¢å³¶åœ°å€": [
            ["https://phhcc.ebook.hyread.com.tw", "æ¾æ¹–ç¸£åœ–æ›¸é¤¨"],
            ["https://kinmen.ebook.hyread.com.tw", "é‡‘é–€ç¸£æ–‡åŒ–å±€"],
            ["https://lieyu.ebook.hyread.com.tw", "é‡‘é–€ç¸£çƒˆå¶¼é„‰å…¬æ‰€"],
            ["https://matsucc.ebook.hyread.com.tw", "é€£æ±Ÿç¸£å…¬å…±åœ–æ›¸é¤¨"],
        ],
        "è‹—æ —åœ°å€": [ 
            ["https://miaolilib.ebook.hyread.com.tw", "è‹—æ —ç¸£ç«‹åœ–æ›¸é¤¨"],
            ["https://mlcg.ebook.hyread.com.tw", "è‹—æ —å¸‚ç«‹åœ–æ›¸é¤¨"],
            ["https://sanwan.ebook.hyread.com.tw", "è‹—æ —ç¸£ä¸‰ç£é„‰ç«‹åœ–æ›¸é¤¨"],
            ["https://dahu.ebook.hyread.com.tw", "è‹—æ —ç¸£å¤§æ¹–é„‰ç«‹åœ–æ›¸é¤¨"],
            ["https://gungguan.ebook.hyread.com.tw", "è‹—æ —ç¸£å…¬é¤¨é„‰ç«‹åœ–æ›¸é¤¨"],
            ["https://xihu.ebook.hyread.com.tw", "è‹—æ —ç¸£è¥¿æ¹–é„‰ç«‹åœ–æ›¸é¤¨"],
            ["https://nanchuang.ebook.hyread.com.tw", "è‹—æ —ç¸£å—åº„é„‰ç«‹åœ–æ›¸é¤¨"],
            ["https://houlong.ebook.hyread.com.tw", "è‹—æ —ç¸£å¾Œé¾é®ç«‹åœ–æ›¸é¤¨"],
            ["https://yuanli.ebook.hyread.com.tw", "è‹—æ —ç¸£è‹‘è£¡é®ç«‹åœ–æ›¸é¤¨"],
            ["https://tungshiau.ebook.hyread.com.tw", "è‹—æ —ç¸£é€šéœ„é®ç«‹åœ–æ›¸é¤¨"],
            ["https://zaociao.ebook.hyread.com.tw", "è‹—æ —ç¸£é€ æ©‹é„‰ç«‹åœ–æ›¸é¤¨"],
            ["https://stan.ebook.hyread.com.tw", "è‹—æ —ç¸£ç…æ½­é„‰åœ–æ›¸é¤¨"],
            ["https://toufenlib.ebook.hyread.com.tw", "è‹—æ —ç¸£é ­ä»½å¸‚ç«‹åœ–æ›¸é¤¨"],
            ["https://touwu.ebook.hyread.com.tw", "è‹—æ —ç¸£é ­å±‹é„‰ç«‹åœ–æ›¸é¤¨"],
        ],
        "åœ‹ç«‹èˆ‡å…¶ä»–": [
            ["https://ncl.ebook.hyread.com.tw", "åœ‹å®¶åœ–æ›¸é¤¨"],
            ["https://ebook.nlpi.edu.tw", "åœ‹ç«‹å…¬å…±è³‡è¨Šåœ–æ›¸é¤¨"], 
            ["https://ntledu.ebook.hyread.com.tw", "åœ‹ç«‹è‡ºç£åœ–æ›¸é¤¨"],
            ["https://ncltrccs.ebook.hyread.com.tw", "åœ‹å®¶åœ–æ›¸é¤¨è‡ºç£æ¼¢å­¸è³‡æºä¸­å¿ƒ"], 
            ["https://hsinrong.ebook.hyread.com.tw", "æ¬£æ¦®ç´€å¿µåœ–æ›¸é¤¨"],
        ]
    };
    // =======================================================================

    let allLibraryUrlsFlat = []; // Initialize as empty, will be populated in DOMContentLoaded

    const $id = (id) => document.getElementById(id);
    const $qs = (selector) => document.querySelector(selector);
    const $qsa = (selector) => document.querySelectorAll(selector);
    const delay = (ms) => new Promise(resolve => setTimeout(resolve, ms));

    function getRandomUserAgent() {
      const userAgents = [
        'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/96.0.4664.110 Safari/537.36',
        'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/96.0.4664.110 Safari/537.36',
        'Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:95.0) Gecko/20100101 Firefox/95.0',
        'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/95.0.4638.69 Safari/537.36'
      ];
      return userAgents[Math.floor(Math.random() * userAgents.length)];
    }

    function getDynamicDelay() {
      let currentBaseDelay = delayConfig.base;
      if (failedRequests > successfulRequests / 2 && failedRequests > 3) { 
          currentBaseDelay = Math.min(delayConfig.base * delayConfig.errorMultiplier, 7000); 
      }
      const randomDelay = Math.random() * delayConfig.random;
      return currentBaseDelay + randomDelay;
    }
    
    function updateDelayDisplays() {
        $id("current-delay-display").textContent = (delayConfig.base / 1000).toFixed(1) + "ç§’";
        $id("batch-delay-display").textContent = (delayConfig.batchDelay / 1000).toFixed(1) + "ç§’";
    }

    function updateSelectedLibCount() {
        selectedHyreadUrls = Array.from($qsa('input[name="library-url"]:checked')).map(cb => cb.value);
        $id("selected-lib-count").textContent = selectedHyreadUrls.length;
    }

    function saveCheckboxStates() {
        $qsa('input[name="library-url"]').forEach(checkbox => {
            localStorage.setItem("checkbox-" + checkbox.id, checkbox.checked);
        });
        localStorage.setItem("selectAllLibraries", $id("select-all-libraries").checked);
    }

    function loadCheckboxStates() {
        let hasSavedState = false;
        $qsa('input[name="library-url"]').forEach(checkbox => {
            const storedState = localStorage.getItem("checkbox-" + checkbox.id);
            if (storedState !== null) {
                checkbox.checked = storedState === "true";
                hasSavedState = true;
            }
        });
        
        if (hasSavedState) {
            const selectAllState = localStorage.getItem("selectAllLibraries");
             if (selectAllState !== null) $id("select-all-libraries").checked = selectAllState === "true";
        } else {
            const defaultLibs = ["https://tpml.ebook.hyread.com.tw", "https://tphcc.ebook.hyread.com.tw", "https://ebook.nlpi.edu.tw", "https://taichunggov.ebook.hyread.com.tw", "https://ksml.ebook.hyread.com.tw"];
            $qsa('input[name="library-url"]').forEach(cb => {
                const cleanedCBValue = cb.value.endsWith('/') ? cb.value.slice(0, -1) : cb.value;
                if (defaultLibs.includes(cleanedCBValue)) cb.checked = true;
            });
            $id("select-all-libraries").checked = false; 
        }
        updateSelectedLibCount();
        filterLibraries(); 
    }
    
    function createLibraryCheckboxes() {
        console.log("Attempting to create library checkboxes..."); // DEBUG
        const container = $id("library-checkboxes-container");
        
        if (!container) {
            console.error("Fatal Error: #library-checkboxes-container not found in DOM.");
            return;
        }
        container.innerHTML = ''; // Clear previous content or placeholder
        
        console.log("libraryDataFull at createLibraryCheckboxes:", JSON.parse(JSON.stringify(libraryDataFull))); // DEBUG: Deep copy for logging

        if (typeof libraryDataFull !== 'object' || libraryDataFull === null || Object.keys(libraryDataFull).length === 0) {
            container.innerHTML = "<p style='color:red;'>éŒ¯èª¤ï¼šåœ–æ›¸é¤¨æ•¸æ“š (libraryDataFull) ç‚ºç©ºæˆ–æœªæ­£ç¢ºè¼‰å…¥ã€‚è«‹æª¢æŸ¥ script ä¸­çš„ libraryDataFull ç‰©ä»¶ã€‚</p>";
            console.error("libraryDataFull is empty, null, or not an object with keys. Cannot create checkboxes.");
            return;
        }
        
        let checkboxIndex = 0;
        let librariesAdded = 0; // DEBUG

        for (const groupName in libraryDataFull) {
            if (Object.hasOwnProperty.call(libraryDataFull, groupName) && Array.isArray(libraryDataFull[groupName])) {
                console.log(`Processing group: ${groupName}`); // DEBUG
                const groupDiv = document.createElement('div');
                groupDiv.className = 'library-group';
                
                const groupTitle = document.createElement('h4');
                groupTitle.textContent = groupName;
                groupDiv.appendChild(groupTitle);

                libraryDataFull[groupName].forEach(lib => {
                    if (Array.isArray(lib) && lib.length >= 2) {
                        const url = String(lib[0]); // Ensure string
                        const name = String(lib[1]); // Ensure string
                        const id = `lib-cb-${checkboxIndex++}`;

                        const label = document.createElement("label");
                        label.setAttribute("for", id);
                        label.title = url; 

                        const checkbox = document.createElement("input");
                        checkbox.type = "checkbox";
                        checkbox.name = "library-url";
                        checkbox.value = url.endsWith('/') ? url.slice(0, -1) : url;
                        checkbox.id = id;
                        checkbox.addEventListener("change", () => {
                            updateSelectedLibCount();
                            saveCheckboxStates(); 
                            updateSelectAllCheckboxState();
                        });

                        label.appendChild(checkbox);
                        label.appendChild(document.createTextNode(name));
                        groupDiv.appendChild(label);
                        librariesAdded++; // DEBUG
                    } else {
                        console.warn("Skipping invalid library entry in group", groupName, ":", lib);
                    }
                });
                if (libraryDataFull[groupName].length > 0) { // Only append groupDiv if it has libraries
                    container.appendChild(groupDiv);
                }
            } else {
                 console.warn("Skipping invalid group in libraryDataFull:", groupName, libraryDataFull[groupName]);
            }
        }

        if (librariesAdded === 0 && Object.keys(libraryDataFull).length > 0) {
             container.innerHTML = "<p style='color:orange;'>è­¦å‘Šï¼šåœ–æ›¸é¤¨æ•¸æ“š (libraryDataFull) ä¼¼ä¹å·²è¼‰å…¥ï¼Œä½†æœªæˆåŠŸç”Ÿæˆä»»ä½•åœ–æ›¸é¤¨é¸é …ã€‚è«‹æª¢æŸ¥æ•¸æ“šæ ¼å¼ã€‚</p>";
             console.warn("libraryDataFull seems loaded, but no checkboxes were added. Check data format inside groups.");
        } else if (librariesAdded > 0) {
            console.log(`Successfully added ${librariesAdded} library checkboxes.`); // DEBUG
        }
        
        loadCheckboxStates(); 
    }
    
    function updateSelectAllCheckboxState() {
        const allVisibleCheckboxes = Array.from($qsa('input[name="library-url"]'))
                                       .filter(cb => cb.parentElement.style.display !== 'none');
        const allVisibleChecked = allVisibleCheckboxes.every(cb => cb.checked);
        $id("select-all-libraries").checked = allVisibleCheckboxes.length > 0 && allVisibleChecked;
    }


    function filterLibraries() {
        const filterText = $id("library-filter-input").value.toLowerCase();
        $qsa('#library-checkboxes-container label').forEach(label => {
            const libName = label.textContent.toLowerCase();
            if (libName.includes(filterText)) {
                label.style.display = 'flex';
            } else {
                label.style.display = 'none';
            }
        });
        updateSelectAllCheckboxState();
    }

    function updateDetailedSearchProgress(processed, total) {
        const percentage = total > 0 ? (processed / total) * 100 : 0;
        const progressBar = $qs(".progress-bar");
        progressBar.style.width = percentage + '%';
        progressBar.textContent = `${processed}/${total}`;
        $id("processed-count").textContent = processed;
        $id("total-count").textContent = total;
    }

    function updateStatusInfo(message) {
        $id("status-message").textContent = message;
        $id("success-count").textContent = successfulRequests;
        $id("failed-count").textContent = failedRequests;
        $id("current-batch-info").textContent = currentBatchNum;
        $id("total-batch-info").textContent = totalBatchesNum;
    }

    function resetDetailedSearchUI(isNewSearch = true) {
        successfulRequests = 0;
        failedRequests = 0;
        processedLibsCount = 0;
        currentBatchNum = 0;
        totalBatchesNum = 0;
        updateDetailedSearchProgress(0, 0);
        if (isNewSearch) {
            $id("detailed-findbook-results").innerHTML = 'æŸ¥è©¢çµæœå°‡é¡¯ç¤ºæ–¼æ­¤...';
        }
        updateStatusInfo("å¾…æ©Ÿä¸­");
        $id("pause-resume-button").textContent = "æš«åœæœå°‹";
        $id("pause-resume-button").disabled = true; 
        $id("cancel-search-button").disabled = true; 
        isPaused = false;
    }

    async function performInitialBookSearch() {
        const bookName = $id("book-name-input").value.trim();
        if (!bookName) {
            alert("è«‹è¼¸å…¥æ›¸åé—œéµå­—ã€‚");
            return;
        }

        $id("initial-search-button").disabled = true;
        $id("initial-search-button").textContent = "æœå°‹ä¸­...";
        $id("initial-results-section").style.display = 'block';
        $id("initial-results").innerHTML = '<p>æ­£åœ¨å‘ Hyread ä¸»ç«™æŸ¥è©¢æ›¸åï¼Œè«‹ç¨å€™...</p>';

        const searchUrl = `https://ebook.hyread.com.tw/searchList.jsp?search_field=FullText&search_input=${encodeURIComponent(bookName)}`;
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 20000);

        try {
            const response = await fetch(searchUrl, {
                signal: controller.signal
            });
            clearTimeout(timeoutId);

            if (!response.ok) throw new Error(`HTTP error ${response.status}`);
            
            const data = await response.text();
            const parser = new DOMParser();
            const doc = parser.parseFromString(data, "text/html");
            
            const bookItems = doc.querySelectorAll('div.book-title-01');
            if (bookItems.length === 0) {
                $id("initial-results").innerHTML = `<p>åœ¨ Hyread ä¸»ç«™æœªæ‰¾åˆ°ç¬¦åˆã€Œ${bookName}ã€çš„æ›¸ç±ã€‚è«‹å˜—è©¦å…¶ä»–é—œéµå­—ã€‚</p>`;
                return;
            }

            let resultsHtml = '';
            bookItems.forEach((item, index) => {
                const linkElement = item.querySelector('a');
                if (linkElement) {
                    const title = linkElement.textContent.trim();
                    const rawHref = linkElement.getAttribute('href'); 

                    const bookIdMatchSimple = rawHref ? rawHref.match(/id=(\d+)/) : null;
                    const simpleBookIdForDisplay = bookIdMatchSimple ? bookIdMatchSimple[1] : "æœªçŸ¥ID";

                    if (rawHref) { 
                        resultsHtml += `
                            <div class="result-item">
                                <span>${title.replace(/</g, "<").replace(/>/g, ">")} (ID: ${simpleBookIdForDisplay})</span>
                                <button class="action-button" 
                                        onclick="startDetailedBookSearchWrapper('${rawHref.replace(/'/g, "\\'").replace(/"/g, """)}', 
                                                                             '${title.replace(/'/g, "\\'").replace(/"/g, """)}')">
                                    æŸ¥è©¢æ­¤æ›¸åœ¨å„é¤¨æƒ…æ³
                                </button>
                            </div>`;
                    }
                }
            });
            $id("initial-results").innerHTML = resultsHtml || '<p>ç„¡æ³•è§£ææœå°‹çµæœï¼Œæˆ–çµæœä¸­ç„¡æœ‰æ•ˆæ›¸ç±IDã€‚</p>';

        } catch (error) {
            clearTimeout(timeoutId);
            console.error("Initial book search failed:", error);
            let errorMsg = 'æŸ¥è©¢ Hyread ä¸»ç«™æ™‚ç™¼ç”ŸéŒ¯èª¤ã€‚';
            if (error.name === 'AbortError') {
                errorMsg += ' è«‹æ±‚è¶…æ™‚ã€‚';
            } else if (error.message.toLowerCase().includes('failed to fetch')) { 
                errorMsg += ' ç¶²è·¯é€£ç·šå¤±æ•—æˆ–CORSå•é¡Œã€‚';
                if (navigator.userAgent.includes('Safari') && !navigator.userAgent.includes('Chrome')) {
                     $id("safari-warning-placeholder").style.display = 'block';
                }
            } else {
                errorMsg += ` (${error.message}).`;
            }
            $id("initial-results").innerHTML = `<p style="color:red;">${errorMsg}</p>`;
        } finally {
            $id("initial-search-button").disabled = false;
            $id("initial-search-button").textContent = "æœå°‹æ›¸å";
        }
    }
    
    window.startDetailedBookSearchWrapper = (bookPathIdentifier, bookTitle) => {
        startDetailedBookSearch(bookPathIdentifier, bookTitle).catch(err => {
            console.error("Error starting detailed search:", err);
            updateStatusInfo("å•Ÿå‹•è©³ç´°æœå°‹æ™‚ç™¼ç”ŸéŒ¯èª¤ã€‚");
        });
    };

    async function startDetailedBookSearch(bookPathIdentifier, bookTitle) {
        if (isDetailedSearching) {
            alert("ç›®å‰å°šæœ‰æŸ¥è©¢ä»»å‹™é€²è¡Œä¸­ï¼Œè«‹ç­‰å¾…å®Œæˆæˆ–å–æ¶ˆå¾Œå†è©¦ã€‚");
            return;
        }
        if (selectedHyreadUrls.length === 0) {
            alert("è«‹è‡³å°‘é¸æ“‡ä¸€å€‹åœ–æ›¸é¤¨é€²è¡ŒæŸ¥è©¢ã€‚");
            return;
        }

        $id("detailed-search-section").style.display = 'block';
        $id('detailed-search-section').scrollIntoView({ behavior: 'smooth' });
        resetDetailedSearchUI(true);
        
        isDetailedSearching = true;
        isPaused = false;
        currentSearchAbortController = new AbortController();
        $id("pause-resume-button").disabled = false;
        $id("cancel-search-button").disabled = false;

        updateStatusInfo(`é–‹å§‹æŸ¥è©¢ã€Œ${bookTitle.replace(/</g, "<").replace(/>/g, ">")}ã€åœ¨ ${selectedHyreadUrls.length} å€‹åœ–æ›¸é¤¨çš„æƒ…æ³...`);

        const batchSize = parseInt($id("batch-size-select").value);
        const batches = [];
        for (let i = 0; i < selectedHyreadUrls.length; i += batchSize) {
            batches.push(selectedHyreadUrls.slice(i, i + batchSize));
        }
        totalBatchesNum = batches.length;
        totalLibsToQuery = selectedHyreadUrls.length;
        updateDetailedSearchProgress(0, totalLibsToQuery);

        let allResultsHtmlPieces = []; 

        for (let i = 0; i < batches.length; i++) {
            if (currentSearchAbortController.signal.aborted) {
                updateStatusInfo("æŸ¥è©¢å·²å–æ¶ˆã€‚");
                break;
            }
            while (isPaused && !currentSearchAbortController.signal.aborted) { 
                 updateStatusInfo(`æŸ¥è©¢å·²æš«åœã€‚æ‰¹æ¬¡ ${currentBatchNum+1 > totalBatchesNum ? totalBatchesNum : currentBatchNum+1 }/${totalBatchesNum} ç­‰å¾…ä¸­...`);
                await delay(1000);
            }
            if (currentSearchAbortController.signal.aborted) break;

            currentBatchNum = i + 1;
            updateStatusInfo(`è™•ç†ç¬¬ ${currentBatchNum}/${totalBatchesNum} æ‰¹æ¬¡...`);
            
            const batchUrls = batches[i];
            const batchPromises = batchUrls.map(libUrl => 
                querySingleLibrary(libUrl, bookPathIdentifier, currentSearchAbortController.signal)
            );
            
            const batchResults = await Promise.all(batchPromises);
            
            if ($id("detailed-findbook-results").innerHTML.startsWith('æŸ¥è©¢çµæœå°‡é¡¯ç¤ºæ–¼æ­¤')) {
                $id("detailed-findbook-results").innerHTML = ''; 
            }

            batchResults.forEach(result => {
                if (currentSearchAbortController.signal.aborted) return; 
                if (result) {
                    allResultsHtmlPieces.push(result); 
                    $id("detailed-findbook-results").insertAdjacentHTML('beforeend', result); 
                }
                processedLibsCount++; 
                updateDetailedSearchProgress(processedLibsCount, totalLibsToQuery);
            });

            if (currentSearchAbortController.signal.aborted) break;
            updateStatusInfo(`ç¬¬ ${currentBatchNum}/${totalBatchesNum} æ‰¹æ¬¡å®Œæˆã€‚`);

            if (i < batches.length - 1 && !currentSearchAbortController.signal.aborted) {
                const batchDelayMs = delayConfig.batchDelay;
                updateStatusInfo(`æ‰¹æ¬¡é–“ä¼‘æ¯ ${(batchDelayMs / 1000).toFixed(1)} ç§’...`);
                
                for (let t = 0; t < batchDelayMs; t += 500) { 
                    if (currentSearchAbortController.signal.aborted) break;
                    await delay(Math.min(500, batchDelayMs - t));
                }
            }
             if (currentSearchAbortController.signal.aborted) break;
        }

        if (allResultsHtmlPieces.length === 0 && !currentSearchAbortController.signal.aborted) {
            $id("detailed-findbook-results").innerHTML = `<p>åœ¨æ‰€é¸åœ–æ›¸é¤¨ä¸­å‡æœªæ‰¾åˆ°ã€Œ${bookTitle.replace(/</g, "<").replace(/>/g, ">")}ã€(æ›¸ç±æ¨™è­˜ç¬¦: ${bookPathIdentifier.replace(/</g, "<").replace(/>/g, ">")})ï¼Œæˆ–æ‰€æœ‰è«‹æ±‚å‡å¤±æ•—ã€‚</p>`;
        } else if (currentSearchAbortController.signal.aborted) {
             $id("detailed-findbook-results").innerHTML += `<p style="color:red; font-weight:bold;">æŸ¥è©¢å·²å–æ¶ˆã€‚</p>`; 
        }
        
        if (!currentSearchAbortController.signal.aborted) {
            updateStatusInfo(`æ‰€æœ‰åœ–æ›¸é¤¨æŸ¥è©¢å®Œæˆï¼å…±æ‰¾åˆ° ${successfulRequests} ç­†æœ‰æ•ˆçµæœã€‚`);
        }
        isDetailedSearching = false;
        $id("pause-resume-button").disabled = true;
        $id("cancel-search-button").disabled = true;
    }
    
    async function querySingleLibrary(libraryBaseUrl, bookPathIdentifier, mainAbortSignal) {
        const cleanedBaseUrl = libraryBaseUrl.endsWith('/') ? libraryBaseUrl.slice(0, -1) : libraryBaseUrl;
        
        const pathPart = bookPathIdentifier.startsWith('/') ? bookPathIdentifier : '/' + bookPathIdentifier;
        let apiUrl = `${cleanedBaseUrl}${pathPart}`; 
        apiUrl = apiUrl.replace(/([^:])\/\//g, '$1/');

        console.log("Attempting to query (using path identifier):", apiUrl);

        const dynamicReqDelay = getDynamicDelay();
        await delay(dynamicReqDelay);
        updateDelayDisplays(); 

        const requestTimeoutController = new AbortController();
        const timeoutId = setTimeout(() => requestTimeoutController.abort('timeout'), 25000); 

        let combinedSignal;
        if (typeof AbortSignal.any === 'function') {
            combinedSignal = AbortSignal.any([mainAbortSignal, requestTimeoutController.signal]);
        } else {
            combinedSignal = requestTimeoutController.signal; 
            const mainAbortListener = () => requestTimeoutController.abort('mainAbort');
            mainAbortSignal.addEventListener('abort', mainAbortListener, { once: true });
            combinedSignal.addEventListener('abort', () => mainAbortSignal.removeEventListener('abort', mainAbortListener), { once: true });
        }

        const fetchOptions = {
            headers: {
                'User-Agent': getRandomUserAgent(), 
                'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8',
            },
            signal: combinedSignal,
        };

        try {
            const response = await fetch(apiUrl, fetchOptions);
            clearTimeout(timeoutId); 
            if (mainAbortSignal.aborted) return null; 

            if (!response.ok) {
                console.warn(`HTTP error ${response.status} for ${apiUrl}. Library: ${cleanedBaseUrl}`);
                failedRequests++;
                return null; 
            }
            const responseText = await response.text();
            if (mainAbortSignal.aborted) return null;

            const parser = new DOMParser();
            const doc = parser.parseFromString(responseText, "text/html");

            if (doc.querySelector('img[src="/Template/RWD3.0/images/nosale2_pic.png"], img[alt*="æœ¬é¤¨ç„¡æ­¤æ›¸"], img[alt*="æŸ¥ç„¡æ­¤æ›¸"]') || responseText.includes("æœ¬é¤¨ç„¡æ­¤æ›¸") || responseText.includes("æŸ¥ç„¡æ­¤æ›¸")) {
                return null; 
            }

            const bookTitleElem = doc.querySelector('h3, h3.book-title-01, div.SubsectShw-H01 h3, h3#bookTitle, meta[property="og:title"]');
            const myStateButton = doc.querySelector('#myStateButton, a.btnTypeA_ MeternewGray, .bookShowBtn .btnTypeA_OK'); 
            
            let bookActualTitle = "æ›¸åæœªçŸ¥ (è«‹æª¢æŸ¥é é¢)";
            if(bookTitleElem){
                bookActualTitle = (bookTitleElem.tagName === 'META' ? bookTitleElem.getAttribute('content') : bookTitleElem.textContent).trim();
                if (bookTitleElem.tagName === 'META') {
                    let parts = bookActualTitle.split(/[-â€“â€”]\s*HyRead|@|\|/); 
                    bookActualTitle = parts[0].trim();
                }
            } else {
                const pageTitleTag = doc.querySelector('title');
                if(pageTitleTag) bookActualTitle = pageTitleTag.textContent.trim().split(/[-â€“â€”]\s*HyRead|@|\|/)[0].trim();
            }

            if (!myStateButton && !bookTitleElem) { 
                 const notFoundMessages = ["æŸ¥ç„¡æ­¤æ›¸", "æ›¸ç±ä¸å­˜åœ¨", "ç„¡æ³•æä¾›", "é é¢ä¸å­˜åœ¨"];
                if (notFoundMessages.some(msg => doc.body.textContent.includes(msg))) {
                    return null;
                }
                console.warn(`Could not find critical elements (title/button) for ${apiUrl}. Response might be an error page or unexpected format.`);
                return null; 
            }

            let libraryName = "æœªçŸ¥åœ–æ›¸é¤¨"; // Default
            if (allLibraryUrlsFlat && allLibraryUrlsFlat.length > 0) { // Check if allLibraryUrlsFlat is populated
                 const foundLib = allLibraryUrlsFlat.find(lib => lib[0] === cleanedBaseUrl);
                 if (foundLib) libraryName = foundLib[1];
                 else libraryName = cleanedBaseUrl; // Fallback to URL if name not found
            } else {
                console.warn("allLibraryUrlsFlat is not populated, cannot get library name for", cleanedBaseUrl);
                libraryName = cleanedBaseUrl; // Fallback if allLibraryUrlsFlat is empty
            }


            let buttonText = myStateButton ? myStateButton.textContent.trim() : "ç‹€æ…‹æŒ‰éˆ•æœªçŸ¥";
            let statusText = "";

            if (buttonText.includes("è¨ˆæ¬¡æœå‹™") || (myStateButton && myStateButton.href && myStateButton.href.includes("meter"))) {
                buttonText = `è¨ˆæ¬¡æœå‹™`;
            }
            
            const collectionElem = doc.querySelector('#Collection, #combineSite0, .SubsectShw-H04, .bookDetailBoxL dd'); 
            if (collectionElem) {
                statusText = collectionElem.textContent.trim().replace(/\s+/g, ' '); 
            }
            
            const hitsElem = doc.querySelector('.date, .book-data .hits, .SubsectShw-H03 span'); 
            let hitsText = "";
            if(hitsElem) {
                const rawHits = hitsElem.textContent.match(/äººæ°£[:ï¼š\s]*(\d+)/i) || hitsElem.textContent.match(/(\d+)\s*æ¬¡/i);
                if(rawHits && rawHits[1]) hitsText = `[äººæ°£ ${rawHits[1]}]`;
                else if (hitsElem.textContent.match(/\d+/)) hitsText = `[${hitsElem.textContent.trim()}]`;
            }

            successfulRequests++; 
            return `
                <div class="book-entry">
                    <strong><a href="${apiUrl}" target="_blank">${bookActualTitle.replace(/</g, "<").replace(/>/g, ">")}</a></strong> ${hitsText}<br>
                    åœ–æ›¸é¤¨: ${libraryName.replace(/</g, "<").replace(/>/g, ">")}<br>
                    æŒ‰éˆ•ç‹€æ…‹: ${buttonText.replace(/</g, "<").replace(/>/g, ">")}<br>
                    ${statusText ? `é¤¨è—ç‹€æ…‹: ${statusText.replace(/</g, "<").replace(/>/g, ">")}<br>` : ''}
                </div>`;

        } catch (error) {
            clearTimeout(timeoutId);
            if (combinedSignal.aborted) { 
                if (combinedSignal.reason === 'timeout') {
                    console.warn(`Request timed out: ${apiUrl}`);
                    failedRequests++;
                } else if (combinedSignal.reason === 'mainAbort' || mainAbortSignal.aborted) {
                     console.log(`Request cancelled by user: ${apiUrl}`);
                } else {
                    console.log(`Request aborted (${combinedSignal.reason || 'unknown reason'}): ${apiUrl}`);
                    if(combinedSignal.reason !== 'mainAbort') failedRequests++;
                }
            } else {
                console.error(`Failed to query ${apiUrl}:`, error);
                failedRequests++;
                 if (error instanceof TypeError && error.message.toLowerCase().includes('failed to fetch')) {
                    console.warn(`[CORS_ERROR_DETAILS] The request to ${apiUrl} was blocked by the browser's CORS policy. This typically happens when the server at ${cleanedBaseUrl} does not send the 'Access-Control-Allow-Origin' header for requests from this page's origin (likely 'null' if run from a local file). Pure client-side JavaScript cannot bypass this browser security feature. Consider using a browser extension for development or deploying this page to a web server.`);
                }
                if (navigator.userAgent.includes('Safari') && !navigator.userAgent.includes('Chrome')) {
                    $id("safari-warning-placeholder").style.display = 'block';
                }
            }
            return null;
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        console.log("DOM fully loaded and parsed"); // DEBUG

        if (navigator.userAgent.includes('Safari') && !navigator.userAgent.includes('Chrome')) {
            $id("safari-warning-placeholder").style.display = 'block';
        }
        
        // Populate allLibraryUrlsFlat here, ensuring libraryDataFull is available
        if (typeof libraryDataFull === 'object' && libraryDataFull !== null && Object.keys(libraryDataFull).length > 0) {
            allLibraryUrlsFlat = Object.values(libraryDataFull).flat().map(entry => {
                if (Array.isArray(entry) && entry.length >= 1) {
                    const url = String(entry[0]); // Ensure string
                    const name = entry.length >= 2 ? String(entry[1]) : "Unnamed Library"; // Ensure string, provide default
                    return [url.endsWith('/') ? url.slice(0, -1) : url, name];
                }
                return null; // Or handle error for invalid entry
            }).filter(entry => entry !== null); // Remove any null entries from malformed data
            console.log("allLibraryUrlsFlat populated:", allLibraryUrlsFlat.length, "entries"); // DEBUG
        } else {
            console.error("libraryDataFull is not valid for populating allLibraryUrlsFlat.");
        }


        createLibraryCheckboxes(); // This must be called after libraryDataFull is defined
        updateDelayDisplays();

        $id("initial-search-button").addEventListener("click", performInitialBookSearch);
        
        $id("select-all-libraries").addEventListener("change", function() {
            const isChecked = this.checked;
            $qsa('input[name="library-url"]').forEach(checkbox => {
                if (checkbox.parentElement.style.display !== 'none') { 
                    checkbox.checked = isChecked;
                }
            });
            updateSelectedLibCount();
            saveCheckboxStates(); 
        });

        $id("library-filter-input").addEventListener("input", filterLibraries);

        $id("delay-slider").addEventListener("input", (e) => {
            delayConfig.base = parseInt(e.target.value);
            updateDelayDisplays();
        });
        $id("batch-delay-slider").addEventListener("input", (e) => {
            delayConfig.batchDelay = parseInt(e.target.value);
            updateDelayDisplays();
        });

        $id("delay-slider").addEventListener("change", (e) => localStorage.setItem("delayBase", e.target.value));
        $id("batch-delay-slider").addEventListener("change", (e) => localStorage.setItem("batchDelay", e.target.value));
        $id("batch-size-select").addEventListener("change", (e) => localStorage.setItem("batchSize", e.target.value));

        if(localStorage.getItem("delayBase")) {
            $id("delay-slider").value = localStorage.getItem("delayBase");
            delayConfig.base = parseInt($id("delay-slider").value);
        }
        if(localStorage.getItem("batchDelay")) {
            $id("batch-delay-slider").value = localStorage.getItem("batchDelay");
            delayConfig.batchDelay = parseInt($id("batch-delay-slider").value);
        }
        if(localStorage.getItem("batchSize")) {
            $id("batch-size-select").value = localStorage.getItem("batchSize");
        }
        updateDelayDisplays();

        $id("pause-resume-button").addEventListener("click", () => {
            isPaused = !isPaused;
            if (isPaused) {
                $id("pause-resume-button").textContent = "ç¹¼çºŒæœå°‹";
                $id("pause-resume-button").classList.remove('pause-button'); 
                updateStatusInfo(`æŸ¥è©¢å·²æš«åœã€‚ç­‰å¾…ç¹¼çºŒ...`);
            } else {
                $id("pause-resume-button").textContent = "æš«åœæœå°‹";
                $id("pause-resume-button").classList.add('pause-button');
            }
        });

        $id("cancel-search-button").addEventListener("click", () => {
            if (currentSearchAbortController && !currentSearchAbortController.signal.aborted) {
                currentSearchAbortController.abort(); 
            }
            isDetailedSearching = false; 
            isPaused = false;
            $id("pause-resume-button").disabled = true;
            $id("cancel-search-button").disabled = true;
            updateStatusInfo("æŸ¥è©¢å·²å–æ¶ˆã€‚");
        });
        resetDetailedSearchUI(false); 
    });
  </script>
</body>
</html>
