<!DOCTYPE html>
<html lang="zh-Hant">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Hyread 電子書多館查詢 Pro (Revisit Lib Load)</title>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <style>
    :root {
      --primary-color: #007bff;
      --secondary-color: #6c757d;
      --success-color: #28a745;
      --warning-color: #ffc107;
      --danger-color: #dc3545;
      --light-color: #f8f9fa;
      --dark-color: #343a40;
      --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      --border-radius: 0.3rem;
      --box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    }

    body {
      font-family: var(--font-family);
      line-height: 1.6;
      margin: 0;
      padding: 0;
      background-color: #eef2f7;
      color: var(--dark-color);
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    
    .main-container {
        max-width: 1200px;
        margin: 20px auto;
        padding: 20px;
        background-color: #fff;
        border-radius: var(--border-radius);
        box-shadow: var(--box-shadow);
    }

    header {
      background: linear-gradient(135deg, var(--primary-color), #0056b3);
      color: white;
      padding: 20px;
      text-align: center;
      border-bottom: 5px solid #0056b3;
    }
    header h1 { margin: 0; font-size: 2rem; }

    .search-area, .settings-area, .library-selection-area, .results-area, .findbook-area {
      margin-bottom: 25px;
      padding: 20px;
      background-color: var(--light-color);
      border-radius: var(--border-radius);
      border: 1px solid #dee2e6;
    }
    
    .search-area h2, .settings-area h2, .library-selection-area h2, .results-area h2, .findbook-area h2 {
        margin-top: 0;
        color: var(--primary-color);
        border-bottom: 2px solid var(--primary-color);
        padding-bottom: 10px;
        font-size: 1.5rem;
    }

    input[type="text"], select {
      width: 100%;
      padding: 10px;
      margin-bottom: 10px;
      border: 1px solid #ced4da;
      border-radius: var(--border-radius);
      box-sizing: border-box;
      font-size: 1rem;
    }
    
    button, .button {
      background-color: var(--primary-color);
      color: white;
      padding: 10px 18px;
      border: none;
      border-radius: var(--border-radius);
      cursor: pointer;
      font-size: 1rem;
      transition: background-color 0.2s ease-in-out;
      text-decoration: none;
      display: inline-block;
      text-align: center;
    }
    button:hover, .button:hover { background-color: #0056b3; }
    button:disabled { background-color: var(--secondary-color); cursor: not-allowed; }

    .search-init-button { width: auto; min-width: 120px; }
    .action-button { padding: 8px 12px; font-size: 0.9rem; margin-left: 5px; }
    .pause-button { background-color: var(--warning-color); color: black; }
    .pause-button:hover { background-color: #e0a800; }
    .cancel-button { background-color: var(--danger-color); }
    .cancel-button:hover { background-color: #c82333; }

    #library-checkboxes-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 10px;
      max-height: 400px;
      overflow-y: auto;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: var(--border-radius);
      background-color: white;
      min-height: 50px; 
    }
    #library-checkboxes-container label {
      display: flex;
      align-items: center;
      padding: 8px;
      background-color: #f8f9fa;
      border-radius: var(--border-radius);
      transition: background-color 0.2s;
      cursor: pointer;
    }
    #library-checkboxes-container label:hover { background-color: #e9ecef; }
    #library-checkboxes-container input[type="checkbox"] {
      margin-right: 10px;
      width: auto; 
      margin-bottom: 0; 
    }
    .library-group { margin-bottom: 15px; }
    .library-group h4 { margin-bottom: 8px; font-size: 1.1rem; color: var(--secondary-color); }

    .progress-container {
      margin: 15px 0;
      background-color: #e9ecef;
      border-radius: var(--border-radius);
      overflow: hidden;
    }
    .progress-bar {
      height: 25px;
      background: linear-gradient(45deg, var(--success-color), #218838);
      width: 0%;
      transition: width 0.3s ease;
      text-align: center;
      line-height: 25px;
      color: white;
      font-size: 0.9rem;
    }

    .status-info {
      margin: 15px 0;
      padding: 12px;
      background-color: #e6f7ff;
      border: 1px solid #b3e0ff;
      border-radius: var(--border-radius);
      font-size: 0.95rem;
    }
    .status-info div { margin-bottom: 5px; }
    .status-info span { font-weight: bold; }

    .settings-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 20px;
    }
    .setting-item label { display: block; margin-bottom: 8px; font-weight: 500; }
    .setting-item input[type="range"] { width: 100%; }
    .setting-item span { font-weight: normal; color: var(--primary-color); }

    #initial-results .result-item {
        padding: 10px;
        border-bottom: 1px solid #eee;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    #initial-results .result-item:last-child { border-bottom: none; }
    #initial-results .result-item span { flex-grow: 1; margin-right: 10px; }

    #detailed-findbook-results .book-entry {
      padding: 15px;
      margin-bottom: 15px;
      background-color: white;
      border: 1px solid #ddd;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
    }
    #detailed-findbook-results .book-entry a { color: var(--primary-color); text-decoration: none; font-weight: bold; }
    #detailed-findbook-results .book-entry a:hover { text-decoration: underline; }
    #detailed-findbook-results .book-entry hr { border: 0; border-top: 1px solid #eee; margin: 10px 0; }
    
    .safari-warning {
        background-color: #fff3cd;
        border-color: #ffeeba;
        color: #856404;
        padding: 15px;
        margin-bottom: 20px;
        border: 1px solid transparent;
        border-radius: var(--border-radius);
    }

    footer {
      text-align: center;
      padding: 15px;
      background-color: var(--dark-color);
      color: var(--light-color);
      margin-top: auto;
      font-size: 0.9em;
    }

    @media (max-width: 768px) {
      header h1 { font-size: 1.5rem; }
      .search-area h2, .settings-area h2, .library-selection-area h2, .results-area h2, .findbook-area h2 { font-size: 1.25rem; }
      #library-checkboxes-container { grid-template-columns: 1fr; }
      .settings-grid { grid-template-columns: 1fr; }
      button, .button { width: 100%; margin-bottom: 10px; }
      .action-button { width: auto; }
      .search-init-button { width: 100%; }
      #initial-results .result-item { flex-direction: column; align-items: flex-start; }
      #initial-results .result-item button { margin-top: 10px; }
    }
  </style>
</head>

<body>
  <header>
    <h1>Hyread 電子書多館查詢 Pro (Revisit Lib Load)</h1>
  </header>

  <div class="main-container">
    <div id="safari-warning-placeholder" class="safari-warning" style="display:none;">
      ⚠️ <strong>Safari 使用者請注意：</strong>由於瀏覽器安全限制 (CORS)，部分或全部圖書館的查詢功能可能無法正常運作。建議使用 Chrome 或 Firefox 瀏覽器以獲得最佳體驗。如果問題持續，這可能是 Hyread 伺服器端對請求來源的限制。
    </div>

    <section class="search-area">
      <h2>1. 輸入書名關鍵字</h2>
      <input type="text" id="book-name-input" placeholder="例如：原子習慣">
      <button id="initial-search-button" class="search-init-button">搜尋書名</button>
    </section>

    <section class="results-area" id="initial-results-section" style="display:none;">
      <h2>2. 選擇要查詢的書籍版本</h2>
      <div id="initial-results"></div>
    </section>
    
    <section class="library-selection-area">
        <h2>3. 選擇圖書館 (<span id="selected-lib-count">0</span> 個已選)</h2>
        <div>
            <input type="checkbox" id="select-all-libraries" style="width:auto; margin-bottom: 0;">
            <label for="select-all-libraries" style="cursor:pointer; font-weight:bold;">全選/全不選 (目前篩選結果)</label>
            <input type="text" id="library-filter-input" placeholder="篩選圖書館名稱..." style="margin-top:10px; margin-bottom:5px;">
        </div>
        <div id="library-checkboxes-container">
             <!-- Placeholder removed, will be populated by JS -->
        </div>
    </section>

    <section class="settings-area">
      <h2>4. 進階設定 (可選)</h2>
      <div class="settings-grid">
        <div class="setting-item">
          <label for="delay-slider">請求間隔基礎值: <span id="current-delay-display">1.0秒</span></label>
          <input type="range" id="delay-slider" min="500" max="5000" value="1000">
          <span>(0.5秒 - 5秒)</span>
        </div>
        <div class="setting-item">
          <label for="batch-delay-slider">批次間延遲: <span id="batch-delay-display">5.0秒</span></label>
          <input type="range" id="batch-delay-slider" min="3000" max="15000" value="5000">
          <span>(3秒 - 15秒)</span>
        </div>
        <div class="setting-item">
          <label for="batch-size-select">每批次處理數量:</label>
          <select id="batch-size-select">
            <option value="3">3個館 (較安全)</option>
            <option value="5" selected>5個館 (推薦)</option>
            <option value="8">8個館 (稍快)</option>
            <option value="10">10個館 (快速但風險增加)</option>
          </select>
        </div>
      </div>
    </section>

    <section class="findbook-area" id="detailed-search-section" style="display:none;">
        <h2>5. 圖書館藏查詢進度與結果</h2>
        <div class="findbook-controls" style="margin-bottom:15px;">
            <button id="pause-resume-button" class="action-button pause-button">暫停搜尋</button>
            <button id="cancel-search-button" class="action-button cancel-button">取消搜尋</button>
        </div>
        <div class="progress-container">
            <div class="progress-bar">0/0</div>
        </div>
        <div class="status-info">
            <div>📊 狀態: <span id="status-message">待機中</span></div>
            <div>⏳ 目前批次: <span id="current-batch-info">-</span> / <span id="total-batch-info">-</span></div>
            <div>✅ 成功: <span id="success-count">0</span> | ❌ 失敗: <span id="failed-count">0</span> | 🔄 已處理: <span id="processed-count">0</span>/<span id="total-count">0</span></div>
        </div>
        <div id="detailed-findbook-results">查詢結果將顯示於此</div>
    </section>
  </div>

  <footer>
    <p>© 2024 Hyread 多館查詢 Pro. 改良版。</p>
  </footer>

  <script>
    // Global variables
    let selectedHyreadUrls = [];
    let isDetailedSearching = false;
    let isPaused = false;
    let currentSearchAbortController = null; 
    
    let successfulRequests = 0;
    let failedRequests = 0;
    let processedLibsCount = 0;
    let totalLibsToQuery = 0;
    let currentBatchNum = 0;
    let totalBatchesNum = 0;

    const delayConfig = {
      base: 1000,
      random: 500,
      batchDelay: 5000,
      errorMultiplier: 1.5 
    };

    // =======================================================================
    // == 請將您整理好的 libraryDataFull 物件貼在此處替換下面的示例數據 ==
    // =======================================================================
    const libraryDataFull = {
        "北部地區": [
            ["https://tpml.ebook.hyread.com.tw", "台北市立圖書館"],
            ["https://tphcc.ebook.hyread.com.tw", "新北市立圖書館"],
            ["https://klccab.ebook.hyread.com.tw", "基隆市文化局"],
            ["https://tycccgov.ebook.hyread.com.tw", "桃園市立圖書館"],
            ["https://hcmlgov.ebook.hyread.com.tw", "新竹市圖書館"],
            ["https://hchcc.ebook.hyread.com.tw", "新竹縣公共圖書館"],
            ["https://ilccb.ebook.hyread.com.tw", "宜蘭縣政府文化局"],
        ],
        "中部地區": [
            ["https://taichunggov.ebook.hyread.com.tw", "臺中市立圖書館"],
            ["https://bocach.ebook.hyread.com.tw", "彰化縣公共圖書館"],
            ["https://chcedu.ebook.hyread.com.tw", "彰化雲端電子書庫"],
            ["https://nthccgov.ebook.hyread.com.tw", "南投縣公共圖書館"], 
            ["https://ylccb.ebook.hyread.com.tw", "雲林縣公共圖書館"],
        ],
        "南部地區": [
            ["https://cabcygov.ebook.hyread.com.tw", "嘉義市政府文化局"],
            ["https://cycabgov.ebook.hyread.com.tw", "嘉義縣公共圖書館"],
            ["https://tnml.ebook.hyread.com.tw", "臺南市立圖書館"],
            ["https://ksml.ebook.hyread.com.tw", "高雄市立圖書館"],
            ["https://pthggov.ebook.hyread.com.tw", "屏東縣公共圖書館"],
        ],
        "東部地區": [
            ["https://hccc.ebook.hyread.com.tw", "花蓮縣文化局"],
            ["https://jianlib.ebook.hyread.com.tw", "花蓮縣吉安鄉立圖書館"],
            ["https://hualienlib.ebook.hyread.com.tw", "花蓮縣花蓮市立圖書館"],
            ["https://shlinlib.ebook.hyread.com.tw", "秀林鄉立圖書館"],
            ["https://sinchenlib.ebook.hyread.com.tw", "新城鄉立圖書館"],
            ["https://cclttct.ebook.hyread.com.tw", "臺東縣政府文化處"],
        ],
        "離島地區": [
            ["https://phhcc.ebook.hyread.com.tw", "澎湖縣圖書館"],
            ["https://kinmen.ebook.hyread.com.tw", "金門縣文化局"],
            ["https://lieyu.ebook.hyread.com.tw", "金門縣烈嶼鄉公所"],
            ["https://matsucc.ebook.hyread.com.tw", "連江縣公共圖書館"],
        ],
        "苗栗地區": [ 
            ["https://miaolilib.ebook.hyread.com.tw", "苗栗縣立圖書館"],
            ["https://mlcg.ebook.hyread.com.tw", "苗栗市立圖書館"],
            ["https://sanwan.ebook.hyread.com.tw", "苗栗縣三灣鄉立圖書館"],
            ["https://dahu.ebook.hyread.com.tw", "苗栗縣大湖鄉立圖書館"],
            ["https://gungguan.ebook.hyread.com.tw", "苗栗縣公館鄉立圖書館"],
            ["https://xihu.ebook.hyread.com.tw", "苗栗縣西湖鄉立圖書館"],
            ["https://nanchuang.ebook.hyread.com.tw", "苗栗縣南庄鄉立圖書館"],
            ["https://houlong.ebook.hyread.com.tw", "苗栗縣後龍鎮立圖書館"],
            ["https://yuanli.ebook.hyread.com.tw", "苗栗縣苑裡鎮立圖書館"],
            ["https://tungshiau.ebook.hyread.com.tw", "苗栗縣通霄鎮立圖書館"],
            ["https://zaociao.ebook.hyread.com.tw", "苗栗縣造橋鄉立圖書館"],
            ["https://stan.ebook.hyread.com.tw", "苗栗縣獅潭鄉圖書館"],
            ["https://toufenlib.ebook.hyread.com.tw", "苗栗縣頭份市立圖書館"],
            ["https://touwu.ebook.hyread.com.tw", "苗栗縣頭屋鄉立圖書館"],
        ],
        "國立與其他": [
            ["https://ncl.ebook.hyread.com.tw", "國家圖書館"],
            ["https://ebook.nlpi.edu.tw", "國立公共資訊圖書館"], 
            ["https://ntledu.ebook.hyread.com.tw", "國立臺灣圖書館"],
            ["https://ncltrccs.ebook.hyread.com.tw", "國家圖書館臺灣漢學資源中心"], 
            ["https://hsinrong.ebook.hyread.com.tw", "欣榮紀念圖書館"],
        ]
    };
    // =======================================================================

    let allLibraryUrlsFlat = []; 

    const $id = (id) => document.getElementById(id);
    const $qs = (selector) => document.querySelector(selector);
    const $qsa = (selector) => document.querySelectorAll(selector);
    const delay = (ms) => new Promise(resolve => setTimeout(resolve, ms));

    // ... (其餘輔助函數 getRandomUserAgent, getDynamicDelay, etc. 保持不變) ...
    // (為簡潔，此處省略，它們與上一版相同)
    function getRandomUserAgent() { /* ... */ }
    function getDynamicDelay() { /* ... */ }
    function updateDelayDisplays() { /* ... */ }
    function updateSelectedLibCount() { /* ... */ }
    function saveCheckboxStates() { /* ... */ }
    function loadCheckboxStates() { /* ... */ }
    function updateSelectAllCheckboxState() { /* ... */ }
    function filterLibraries() { /* ... */ }
    function updateDetailedSearchProgress(p,t) { /* ... */ }
    function updateStatusInfo(m) { /* ... */ }
    function resetDetailedSearchUI(isNew) { /* ... */ }
    async function performInitialBookSearch() { /* ... */ }
    window.startDetailedBookSearchWrapper = (p,t) => { /* ... */ };
    async function startDetailedBookSearch(p,t) { /* ... */ }
    async function querySingleLibrary(l,p,s) { /* ... */ }
    // (以上省略的函數，請使用你上一版中已有的、未變動的定義)


    function createLibraryCheckboxes() {
        console.log("[createLibraryCheckboxes] Function called.");
        const container = $id("library-checkboxes-container");
        
        if (!container) {
            console.error("[createLibraryCheckboxes] Fatal Error: Container #library-checkboxes-container not found.");
            return;
        }
        container.innerHTML = ''; // Clear any previous content or placeholder

        if (typeof libraryDataFull !== 'object' || libraryDataFull === null || Object.keys(libraryDataFull).length === 0) {
            const errorMsg = "[createLibraryCheckboxes] Error: libraryDataFull is empty, null, or not a valid object. Cannot create checkboxes.";
            console.error(errorMsg);
            container.innerHTML = `<p style='color:red;'>${errorMsg}</p>`;
            return;
        }
        console.log("[createLibraryCheckboxes] libraryDataFull seems valid. Number of groups:", Object.keys(libraryDataFull).length);

        let checkboxIndex = 0;
        let totalLibrariesAdded = 0;

        for (const groupName in libraryDataFull) {
            // Ensure it's an own property and the value is an array (the list of libraries for the group)
            if (Object.hasOwnProperty.call(libraryDataFull, groupName) && Array.isArray(libraryDataFull[groupName])) {
                const librariesInGroup = libraryDataFull[groupName];
                console.log(`[createLibraryCheckboxes] Processing group: "${groupName}" with ${librariesInGroup.length} libraries.`);

                if (librariesInGroup.length === 0) {
                    console.log(`[createLibraryCheckboxes] Group "${groupName}" is empty, skipping.`);
                    continue; // Skip empty groups
                }

                const groupDiv = document.createElement('div');
                groupDiv.className = 'library-group';
                
                const groupTitle = document.createElement('h4');
                groupTitle.textContent = groupName;
                groupDiv.appendChild(groupTitle);

                librariesInGroup.forEach(libEntry => {
                    // Ensure libEntry is an array with at least two elements [url, name]
                    if (Array.isArray(libEntry) && libEntry.length >= 2) {
                        const url = String(libEntry[0]);
                        const name = String(libEntry[1]);
                        const id = `lib-cb-${checkboxIndex++}`;

                        const label = document.createElement("label");
                        label.setAttribute("for", id);
                        label.title = url; 

                        const checkbox = document.createElement("input");
                        checkbox.type = "checkbox";
                        checkbox.name = "library-url"; // Match this with how selected URLs are gathered
                        checkbox.value = url.endsWith('/') ? url.slice(0, -1) : url; // Store cleaned URL
                        checkbox.id = id;
                        checkbox.addEventListener("change", () => {
                            updateSelectedLibCount();
                            saveCheckboxStates(); 
                            updateSelectAllCheckboxState();
                        });

                        label.appendChild(checkbox);
                        label.appendChild(document.createTextNode(name));
                        groupDiv.appendChild(label); // Append label to groupDiv
                        totalLibrariesAdded++;
                    } else {
                        console.warn(`[createLibraryCheckboxes] Invalid library entry in group "${groupName}":`, libEntry);
                    }
                });
                container.appendChild(groupDiv); // Append groupDiv to the main container
            } else {
                 console.warn(`[createLibraryCheckboxes] Invalid or non-array group in libraryDataFull: "${groupName}"`, libraryDataFull[groupName]);
            }
        }

        if (totalLibrariesAdded === 0) {
            const warnMsg = "[createLibraryCheckboxes] No libraries were added. Check libraryDataFull structure and content.";
            console.warn(warnMsg);
            if (Object.keys(libraryDataFull).length > 0) { // If there were groups but no items
                 container.innerHTML = `<p style='color:orange;'>${warnMsg}</p>`;
            }
        } else {
            console.log(`[createLibraryCheckboxes] Successfully added ${totalLibrariesAdded} library checkboxes to the DOM.`);
        }
        
        // Load saved states after all checkboxes are created
        loadCheckboxStates(); 
    }
    

    document.addEventListener('DOMContentLoaded', () => {
        console.log("DOM fully loaded and parsed. Initializing application...");

        if (navigator.userAgent.includes('Safari') && !navigator.userAgent.includes('Chrome')) {
            $id("safari-warning-placeholder").style.display = 'block';
        }
        
        // Populate allLibraryUrlsFlat after libraryDataFull is defined
        // This is used by querySingleLibrary to get library names.
        if (typeof libraryDataFull === 'object' && libraryDataFull !== null && Object.keys(libraryDataFull).length > 0) {
            allLibraryUrlsFlat = Object.values(libraryDataFull).flat().map(entry => {
                if (Array.isArray(entry) && entry.length >= 1) {
                    const url = String(entry[0]);
                    const name = entry.length >= 2 ? String(entry[1]) : "Unnamed Library";
                    return [url.endsWith('/') ? url.slice(0, -1) : url, name];
                }
                return null; 
            }).filter(entry => entry !== null);
            console.log("allLibraryUrlsFlat populated in DOMContentLoaded. Entries:", allLibraryUrlsFlat.length);
        } else {
            console.error("libraryDataFull is not valid when trying to populate allLibraryUrlsFlat in DOMContentLoaded.");
        }

        // Call to create checkboxes
        createLibraryCheckboxes(); 
        
        updateDelayDisplays(); // Initialize delay display

        // Setup event listeners
        $id("initial-search-button").addEventListener("click", performInitialBookSearch);
        $id("select-all-libraries").addEventListener("change", function() {
            const isChecked = this.checked;
            $qsa('input[name="library-url"]').forEach(checkbox => {
                if (checkbox.parentElement.style.display !== 'none') { 
                    checkbox.checked = isChecked;
                }
            });
            updateSelectedLibCount();
            saveCheckboxStates(); 
        });
        $id("library-filter-input").addEventListener("input", filterLibraries);
        // ... (rest of the event listeners and settings loading code - keep as is)
        $id("delay-slider").addEventListener("input", (e) => { /* ... */ });
        $id("batch-delay-slider").addEventListener("input", (e) => { /* ... */ });
        $id("delay-slider").addEventListener("change", (e) => { /* ... */ });
        $id("batch-delay-slider").addEventListener("change", (e) => { /* ... */ });
        $id("batch-size-select").addEventListener("change", (e) => { /* ... */ });
        // Load settings from localStorage
        if(localStorage.getItem("delayBase")) { /* ... */ }
        if(localStorage.getItem("batchDelay")) { /* ... */ }
        if(localStorage.getItem("batchSize")) { /* ... */ }
        updateDelayDisplays(); // Update display after loading
        $id("pause-resume-button").addEventListener("click", () => { /* ... */ });
        $id("cancel-search-button").addEventListener("click", () => { /* ... */ });
        resetDetailedSearchUI(false); 

        console.log("Application initialization complete.");
    });
  </script>
</body>
</html>
